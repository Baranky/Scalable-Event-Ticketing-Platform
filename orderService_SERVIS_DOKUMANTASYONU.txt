================================================================================
ORDER SERVICE SERVİSİ - CLASS VE METOD DOKÜMANTASYONU
================================================================================

Bu servis, sipariş (order) yönetimi ve Saga pattern ile dağıtık işlem yönetimi yapar.

--------------------------------------------------------------------------------
1. OrderServiceApplication
--------------------------------------------------------------------------------
AÇIKLAMA: Spring Boot uygulamasının ana başlangıç sınıfıdır.
İŞLEVİ: 
  - Uygulamayı başlatır
  - Feign Client desteğini aktif eder (Payment ve Ticket servislerine çağrı için)
  - Scheduling desteğini aktif eder (Outbox pattern için)

METODLAR:
  - main(String[] args): Uygulamayı başlatır

NOTLAR:
  - Port: 8087
  - @EnableFeignClients: Feign Client kullanımını aktif eder
  - @EnableScheduling: Scheduled task'lar için gerekli

--------------------------------------------------------------------------------
2. OrderController
--------------------------------------------------------------------------------
AÇIKLAMA: Order ile ilgili HTTP endpoint'lerini sağlar.
İŞLEVİ: REST API endpoint'leri sunar

METODLAR:
  - createOrder(OrderCreateRequest request): 
      * Basit sipariş oluşturma (POST /api/orders)
      * Saga pattern kullanmaz
  
  - createOrderWithSaga(OrderSagaRequest request): 
      * Saga pattern ile sipariş oluşturma (POST /api/orders/saga)
      * Tüm adımları (lock, payment, confirm, create tickets) otomatik yönetir
      * Hata durumunda compensation yapar
  
  - completeOrder(String id): 
      * Siparişi tamamlar (POST /api/orders/{id}/complete)
      * Ticket'ları oluşturur
  
  - cancelOrder(String id, String reason): 
      * Siparişi iptal eder (POST /api/orders/{id}/cancel)
      * Outbox'a ORDER_CANCELLED event'i kaydeder
  
  - getSagaStatus(String id): 
      * Saga durumunu getirir (GET /api/orders/{id}/saga-status)
      * Hangi adımda olduğunu, başarılı/başarısız durumunu gösterir
  
  - getOrderById(String id): 
      * ID'ye göre sipariş getirir (GET /api/orders/{id})
  
  - getOrders(String userId, OrderStatus status): 
      * Kullanıcıya veya duruma göre siparişleri getirir (GET /api/orders)

--------------------------------------------------------------------------------
3. OrderService (Interface)
--------------------------------------------------------------------------------
AÇIKLAMA: Order işlemleri için servis arayüzü

METODLAR:
  - createOrder(OrderCreateRequest request): Basit sipariş oluşturma
  - createOrderWithSaga(OrderSagaRequest request): Saga ile sipariş oluşturma
  - completeOrder(String orderId): Siparişi tamamlama
  - cancelOrder(String orderId, String reason): Siparişi iptal etme
  - getOrderById(String id): ID'ye göre sipariş getirme
  - getOrdersByUser(String userId): Kullanıcıya göre siparişleri getirme
  - getOrdersByStatus(OrderStatus status): Duruma göre siparişleri getirme
  - getSagaStatus(String orderId): Saga durumunu getirme

--------------------------------------------------------------------------------
4. OrderServiceImpl
--------------------------------------------------------------------------------
AÇIKLAMA: OrderService implementasyonu

METODLAR:
  - createOrder(OrderCreateRequest request): 
      * Idempotency kontrolü yapar (aynı idempotencyKey ile tekrar sipariş oluşturmayı engeller)
      * Ticket Service'ten stok bilgisini alır
      * Stok kontrolü yapar
      * Order ve OrderItem'ları oluşturur
      * Outbox'a ORDER_CREATED event'i kaydeder
  
  - createOrderWithSaga(OrderSagaRequest request): 
      * Saga orchestrator'ı çağırır
  
  - completeOrder(String orderId): 
      * Order'ı PENDING'den COMPLETED'e çevirir
      * Ticket Service'e purchaseTickets çağrısı yapar
      * OrderItem'lara ticket bilgilerini (ticketId, qrCode) ekler
      * Outbox'a ORDER_COMPLETED event'i kaydeder
  
  - cancelOrder(String orderId, String reason): 
      * Order status'ünü CANCELLED yapar
      * Outbox'a ORDER_CANCELLED event'i kaydeder
  
  - getOrderById(String id): 
      * ID'ye göre sipariş ve item'larını getirir
  
  - getOrdersByUser(String userId): 
      * Kullanıcıya ait tüm siparişleri getirir
  
  - getOrdersByStatus(OrderStatus status): 
      * Belirli durumdaki siparişleri getirir
  
  - getSagaStatus(String orderId): 
      * OrderSaga kaydından durum bilgisini getirir
  
  - toResponse(Order order, List<OrderItem> items): 
      * Order ve OrderItem'ları OrderResponse DTO'suna dönüştürür
  
  - toItemDto(OrderItem item): 
      * OrderItem'ı OrderItemDto'ya dönüştürür

--------------------------------------------------------------------------------
5. OrderSagaOrchestrator
--------------------------------------------------------------------------------
AÇIKLAMA: Saga pattern orchestrator - dağıtık işlemleri yönetir
İŞLEVİ: 
  - Sipariş oluşturma sürecini adım adım yönetir
  - Her adım başarısız olursa önceki adımları geri alır (compensation)

METODLAR:
  - executeSaga(OrderSagaRequest request): 
      * Ana saga metodudur
      * Şu adımları sırayla yürütür:
        1. LOCK_TICKETS: Biletleri kilitler (Redis + DB)
        2. PROCESS_PAYMENT: Ödeme işlemini yapar
        3. CONFIRM_SALE: Satışı onaylar
        4. CREATE_TICKETS: Biletleri oluşturur
        5. COMPLETE_ORDER: Siparişi tamamlar
      * Herhangi bir adım başarısız olursa compensate() metodunu çağırır
  
  - compensate(Order order, OrderSaga saga, List<SagaStep> completedSteps, SagaException error): 
      * Başarısız olan saga için compensation yapar
      * Tamamlanan adımları ters sırada geri alır:
        - LOCK_TICKETS → unlockTickets()
        - PROCESS_PAYMENT → (henüz implement edilmemiş)
        - CONFIRM_SALE → (henüz implement edilmemiş)
        - CREATE_TICKETS → (henüz implement edilmemiş)
        - COMPLETE_ORDER → Order'ı CANCELLED yapar
  
  - compensateLockTickets(Order order): 
      * Kilitlenen biletleri açar
  
  - compensatePayment(Order order): 
      * Ödeme iptali (henüz implement edilmemiş)
  
  - compensateConfirmSale(Order order): 
      * Satış onayını geri alma (henüz implement edilmemiş)
  
  - compensateCreateTickets(Order order): 
      * Oluşturulan biletleri silme (henüz implement edilmemiş)
  
  - compensateCompleteOrder(Order order): 
      * Siparişi iptal eder
  
  - createPendingOrder(OrderSagaRequest request, TicketStockResponse stock): 
      * PENDING durumunda Order oluşturur
  
  - createOrderItems(Order order, OrderSagaRequest request, TicketStockResponse stock): 
      * OrderItem'ları oluşturur
  
  - createSaga(String orderId): 
      * OrderSaga kaydı oluşturur
  
  - updateSagaStep(OrderSaga saga, SagaStep step): 
      * Saga'nın mevcut adımını günceller
  
  - createOutboxEvent(Order order, String eventType): 
      * Outbox'a event kaydeder
  
  - stepsToJson(List<SagaStep> steps): 
      * Tamamlanan adımları JSON'a çevirir
  
  - toResponse(Order order, List<OrderItem> items): 
      * Order ve Item'ları OrderResponse DTO'suna dönüştürür

--------------------------------------------------------------------------------
6. SagaStep (Enum)
--------------------------------------------------------------------------------
AÇIKLAMA: Saga pattern'deki adımları tanımlar

DEĞERLER:
  - LOCK_TICKETS: Biletleri kilitle
  - PROCESS_PAYMENT: Ödemeyi işle
  - CONFIRM_SALE: Satışı onayla
  - CREATE_TICKETS: Biletleri oluştur
  - COMPLETE_ORDER: Siparişi tamamla

HER ADIM İÇİN:
  - description: Adımın açıklaması
  - compensationDescription: Geri alma işleminin açıklaması

--------------------------------------------------------------------------------
7. SagaStatus (Enum)
--------------------------------------------------------------------------------
AÇIKLAMA: Saga durumlarını tanımlar

DEĞERLER:
  - STARTED: Başladı
  - IN_PROGRESS: Devam ediyor
  - COMPLETED: Tamamlandı
  - COMPENSATING: Geri alma işlemi yapılıyor
  - COMPENSATED: Geri alma işlemi tamamlandı
  - FAILED: Başarısız oldu

--------------------------------------------------------------------------------
8. SagaStepResult (Record)
--------------------------------------------------------------------------------
AÇIKLAMA: Saga adımının sonucunu tutar

ALANLAR:
  - step: Hangi adım
  - success: Başarılı mı?
  - message: Mesaj
  - data: Ek veri

METODLAR:
  - success(SagaStep step, String message): Başarılı sonuç oluşturur
  - success(SagaStep step, String message, Object data): Veri ile başarılı sonuç
  - failure(SagaStep step, String message): Başarısız sonuç oluşturur

--------------------------------------------------------------------------------
9. SagaException
--------------------------------------------------------------------------------
AÇIKLAMA: Saga işlemi sırasında oluşan özel exception

ALANLAR:
  - failedStep: Hangi adımda başarısız oldu

METODLAR:
  - getFailedStep(): Başarısız olan adımı döner

--------------------------------------------------------------------------------
10. OutboxService
--------------------------------------------------------------------------------
AÇIKLAMA: Transactional Outbox Pattern için event kaydetme servisi
İŞLEVİ: 
  - Order event'lerini outbox tablosuna kaydeder
  - Kafka'ya gönderim OrderOutboxProcessor tarafından yapılır

METODLAR:
  - saveOrderCreatedEvent(Order order, String stockId, int quantity, String eventId): 
      * ORDER_CREATED event'ini outbox'a kaydeder
  
  - saveOrderCompletedEvent(Order order, int ticketCount): 
      * ORDER_COMPLETED event'ini outbox'a kaydeder
  
  - saveOrderCancelledEvent(Order order, String reason): 
      * ORDER_CANCELLED event'ini outbox'a kaydeder
  
  - saveOrderPaymentFailedEvent(Order order, String failureReason): 
      * ORDER_PAYMENT_FAILED event'ini outbox'a kaydeder
  
  - createOutbox(String orderId, String eventType): 
      * OrderOutbox entity'si oluşturur
  
  - toJson(Object obj): 
      * Objeyi JSON string'e çevirir

--------------------------------------------------------------------------------
11. OrderOutboxProcessor
--------------------------------------------------------------------------------
AÇIKLAMA: Outbox tablosundaki event'leri Kafka'ya gönderen scheduler
İŞLEVİ: 
  - Her 5 saniyede bir outbox tablosunu kontrol eder
  - İşlenmemiş event'leri Kafka'ya gönderir
  - Başarısız olanları retry mekanizması ile tekrar dener

METODLAR:
  - processOutbox(): 
      * Her 5 saniyede bir çalışır (@Scheduled)
      * İşlenmemiş event'leri bulur
      * Kafka'ya gönderir
      * Başarılı olanları işaretler
  
  - publishToKafka(OrderOutbox outbox): 
      * Kafka'ya mesaj gönderir
      * Senkron çalışır (sonucu bekler)
  
  - reportDeadLetters(): 
      * Her 1 dakikada bir çalışır
      * 5 kez denenen ama başarısız olan event'leri raporlar
  
  - cleanupProcessedEvents(): 
      * Her gece yarısı çalışır
      * 7 günden eski işlenmiş event'leri siler
  
  - getStats(): 
      * Outbox istatistiklerini döner (pending, processed, deadLetters)

--------------------------------------------------------------------------------
12. Order (Entity)
--------------------------------------------------------------------------------
AÇIKLAMA: Sipariş veritabanı entity'si

ALANLAR:
  - id: Sipariş ID'si (UUID)
  - userId: Kullanıcı ID'si
  - status: Sipariş durumu (PENDING, PAYMENT_PROCESSING, PAID, COMPLETED, CANCELLED, vb.)
  - totalAmount: Toplam tutar
  - currency: Para birimi
  - idempotencyKey: Tekrar istekleri engellemek için kullanılan key
  - stockId: Bilet stoku ID'si
  - quantity: Miktar
  - cancellationReason: İptal nedeni
  - items: Sipariş kalemleri (OneToMany ilişki)
  - createdAt: Oluşturulma tarihi
  - updatedAt: Güncellenme tarihi
  - version: Optimistic locking için versiyon numarası

--------------------------------------------------------------------------------
13. OrderItem (Entity)
--------------------------------------------------------------------------------
AÇIKLAMA: Sipariş kalemi veritabanı entity'si

ALANLAR:
  - id: Kalem ID'si
  - order: Sipariş (ManyToOne ilişki)
  - stockId: Stok ID'si
  - ticketId: Bilet ID'si (bilet oluşturulduktan sonra doldurulur)
  - eventId: Etkinlik ID'si
  - seatLabel: Koltuk etiketi
  - qrCode: QR kod
  - price: Fiyat

--------------------------------------------------------------------------------
14. OrderSaga (Entity)
--------------------------------------------------------------------------------
AÇIKLAMA: Saga işleminin durumunu saklayan entity

ALANLAR:
  - id: Saga ID'si
  - orderId: Sipariş ID'si (unique)
  - status: Saga durumu (STARTED, IN_PROGRESS, COMPLETED, vb.)
  - currentStep: Şu anki adım
  - failedStep: Başarısız olan adım
  - completedSteps: Tamamlanan adımlar (JSON string)
  - errorMessage: Hata mesajı
  - sagaData: Ek saga verisi (JSON)
  - retryCount: Tekrar deneme sayısı
  - createdAt: Oluşturulma tarihi
  - updatedAt: Güncellenme tarihi
  - completedAt: Tamamlanma tarihi

--------------------------------------------------------------------------------
15. OrderOutbox (Entity)
--------------------------------------------------------------------------------
AÇIKLAMA: Transactional Outbox Pattern için event saklama entity'si

ALANLAR:
  - id: Outbox ID'si
  - aggregateType: Aggregate tipi (örn: "Order")
  - aggregateId: Aggregate ID'si (örn: orderId)
  - eventType: Event tipi (ORDER_CREATED, ORDER_COMPLETED, vb.)
  - topic: Kafka topic'i
  - payload: Event verisi (JSON string)
  - processed: İşlendi mi?
  - processedAt: İşlenme tarihi
  - retryCount: Tekrar deneme sayısı
  - lastError: Son hata mesajı
  - createdAt: Oluşturulma tarihi

METODLAR:
  - canRetry(): Tekrar denenebilir mi? (retryCount < 5)
  - markAsProcessed(): İşlendi olarak işaretler
  - markAsFailed(String errorMessage): Başarısız olarak işaretler
  - isDeadLetter(): Dead letter mı? (retryCount >= 5)

--------------------------------------------------------------------------------
16. OrderRepository
--------------------------------------------------------------------------------
AÇIKLAMA: Order entity'si için JPA Repository

METODLAR:
  - findByIdempotencyKey(String idempotencyKey): Idempotency key'e göre bulur
  - findByUserId(String userId): Kullanıcıya göre siparişleri bulur
  - findByStatus(OrderStatus status): Duruma göre siparişleri bulur

--------------------------------------------------------------------------------
17. OrderItemRepository
--------------------------------------------------------------------------------
AÇIKLAMA: OrderItem entity'si için JPA Repository

METODLAR:
  - findByOrder_Id(String orderId): Siparişe göre kalemleri bulur

--------------------------------------------------------------------------------
18. OrderSagaRepository
--------------------------------------------------------------------------------
AÇIKLAMA: OrderSaga entity'si için JPA Repository

METODLAR:
  - findByOrderId(String orderId): Order ID'ye göre saga bulur
  - findByStatus(SagaStatus status): Duruma göre saga'ları bulur
  - findByStatusAndUpdatedAtBefore(SagaStatus status, LocalDateTime threshold): 
      * Belirli durumda ve belirli tarihten önceki saga'ları bulur

--------------------------------------------------------------------------------
19. OrderOutboxRepository
--------------------------------------------------------------------------------
AÇIKLAMA: OrderOutbox entity'si için JPA Repository

METODLAR:
  - findByProcessedFalse(): İşlenmemiş event'leri bulur
  - findUnprocessedOutboxEvents(): İşlenmemiş ve retry sayısı 5'ten az olan event'leri bulur
  - findUnprocessedWithLimit(int limit): Limit ile işlenmemiş event'leri bulur
  - findDeadLetterEvents(): Dead letter event'leri bulur
  - deleteProcessedBefore(LocalDateTime threshold): Belirli tarihten önceki işlenmiş event'leri siler
  - findByAggregateIdOrderByCreatedAtAsc(String aggregateId): Aggregate ID'ye göre event'leri bulur
  - countByProcessedFalse(): İşlenmemiş event sayısı
  - countByProcessedTrue(): İşlenmiş event sayısı
  - countDeadLetters(): Dead letter sayısı

--------------------------------------------------------------------------------
20. OrderStatus (Enum)
--------------------------------------------------------------------------------
AÇIKLAMA: Sipariş durumları

DEĞERLER:
  - PENDING: Beklemede
  - PAYMENT_PROCESSING: Ödeme işleniyor
  - PAID: Ödendi
  - PAYMENT_FAILED: Ödeme başarısız
  - CANCELLED: İptal edildi
  - COMPLETED: Tamamlandı

--------------------------------------------------------------------------------
21. PaymentClient
--------------------------------------------------------------------------------
AÇIKLAMA: Payment Service'e Feign Client ile çağrı yapan interface

METODLAR:
  - createPayment(PaymentRequest request): Ödeme oluşturur

RECORD'LAR:
  - PaymentRequest: Ödeme isteği (orderId, userId, amount, currency, paymentMethod, cardNumber, cvv, expireDate, cardHolderName)
  - PaymentResponse: Ödeme yanıtı (id, orderId, userId, amount, currency, status, paymentMethod, maskedCardNumber, cardHolderName, createdAt)

--------------------------------------------------------------------------------
22. TicketClient
--------------------------------------------------------------------------------
AÇIKLAMA: Ticket Service'e Feign Client ile çağrı yapan interface

METODLAR:
  - getStockById(String stockId): Stok bilgisini getirir
  - getStockByEventAndPriceCategory(String eventId, String priceCategoryId): 
      * Event ve fiyat kategorisine göre stok getirir
  - getStocksByEvent(String eventId): Event'e göre tüm stokları getirir
  - lockTickets(String stockId, int count, String orderId, List<String> seatLabels): 
      * Biletleri kilitler
  - unlockTickets(String stockId, int count, String orderId): 
      * Bilet kilidini açar
  - confirmSale(String stockId, int count, String orderId): 
      * Satışı onaylar
  - getRedisLockedCount(String stockId): 
      * Redis'teki kilitli bilet sayısını getirir
  - purchaseTickets(TicketPurchaseRequest request): 
      * Biletleri satın alır (ticket entity'lerini oluşturur)
  - useTicket(String ticketId, String usedBy): 
      * Bileti kullanır
  - refundTicket(String ticketId, String refundedBy, String reason): 
      * Bileti iade eder

RECORD'LAR:
  - TicketStockResponse: Stok bilgisi
  - TicketPurchaseRequest: Bilet satın alma isteği
  - TicketResponse: Bilet yanıtı

================================================================================
