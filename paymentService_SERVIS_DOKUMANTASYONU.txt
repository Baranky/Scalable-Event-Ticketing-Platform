================================================================================
PAYMENT SERVICE SERVİSİ - CLASS VE METOD DOKÜMANTASYONU
================================================================================

Bu servis, ödeme işlemlerini yönetir ve Transactional Outbox Pattern kullanır.

--------------------------------------------------------------------------------
1. PaymentServiceApplication
--------------------------------------------------------------------------------
AÇIKLAMA: Spring Boot uygulamasının ana başlangıç sınıfıdır.
İŞLEVİ: 
  - Uygulamayı başlatır
  - Feign Client desteğini aktif eder
  - Scheduling desteğini aktif eder (Outbox pattern için)

METODLAR:
  - main(String[] args): Uygulamayı başlatır

NOTLAR:
  - Port: 8088
  - @EnableFeignClients: Feign Client kullanımını aktif eder
  - @EnableScheduling: Scheduled task'lar için gerekli

--------------------------------------------------------------------------------
2. PaymentController
--------------------------------------------------------------------------------
AÇIKLAMA: Payment ile ilgili HTTP endpoint'lerini sağlar.

METODLAR:
  - createPayment(PaymentReq request): 
      * Ödeme oluşturur (POST /api/payments)
      * Simüle edilmiş banka ödemesi yapar
      * Outbox'a PAYMENT_SUCCESS veya PAYMENT_FAILED event'i kaydeder
      * Başarılı ödemelerde ORDER_COMPLETED event'i de kaydeder
  
  - getPayment(String id): 
      * ID'ye göre ödeme bilgisini getirir (GET /api/payments/{id})

--------------------------------------------------------------------------------
3. PaymentService (Interface)
--------------------------------------------------------------------------------
AÇIKLAMA: Payment işlemleri için servis arayüzü

METODLAR:
  - createPayment(PaymentReq request): Ödeme oluşturma
  - getPaymentById(String id): ID'ye göre ödeme getirme

--------------------------------------------------------------------------------
4. PaymentServiceImpl
--------------------------------------------------------------------------------
AÇIKLAMA: PaymentService implementasyonu

METODLAR:
  - createPayment(PaymentReq request): 
      * Simüle edilmiş banka ödemesi yapar (simulateBankPayment)
      * Payment entity'sini oluşturur ve kaydeder
      * Kart numarasını maskeler (maskCardNumber)
      * Outbox'a PAYMENT_SUCCESS veya PAYMENT_FAILED event'i kaydeder
      * Başarılı ödemelerde ORDER_COMPLETED event'i de kaydeder
  
  - getPaymentById(String id): 
      * ID'ye göre ödeme bulur ve PaymentResponse DTO'suna dönüştürür
  
  - simulateBankPayment(PaymentReq request): 
      * Kart numarası 4000 ile başlıyorsa FAILED döner
      * Diğer durumlarda SUCCESS döner
  
  - saveToOutbox(Payment payment, String eventType): 
      * Payment event'ini (PAYMENT_SUCCESS/FAILED) outbox'a kaydeder
  
  - saveOrderCompletedToOutbox(Payment payment): 
      * ORDER_COMPLETED event'ini outbox'a kaydeder
  
  - getPaymentEventType(PaymentStatus status): 
      * PaymentStatus'e göre event tipini döner
  
  - buildPaymentEventPayload(Payment payment, String eventType): 
      * PaymentEvent DTO'sunu JSON'a çevirir
  
  - buildOrderCompletedPayload(Payment payment): 
      * OrderCompletedEvent DTO'sunu JSON'a çevirir
  
  - toResponse(Payment payment): 
      * Payment entity'sini PaymentResponse DTO'suna dönüştürür
  
  - maskCardNumber(String cardNumber): 
      * Kart numarasının son 4 hanesini gösterir, geri kalanını maskeler
      * Örnek: "1234567890123456" → "**** **** **** 3456"

--------------------------------------------------------------------------------
5. OutboxProcessor
--------------------------------------------------------------------------------
AÇIKLAMA: Payment Outbox tablosundaki event'leri Kafka'ya gönderen scheduler
İŞLEVİ: 
  - Her 5 saniyede bir outbox tablosunu kontrol eder
  - İşlenmemiş event'leri Kafka'ya gönderir

METODLAR:
  - processOutbox(): 
      * Her 5 saniyede bir çalışır (@Scheduled)
      * İşlenmemiş event'leri bulur (findUnprocessedWithLimit)
      * Kafka'ya gönderir
      * Başarılı olanları işaretler (markAsProcessed)
      * Başarısız olanları işaretler (markAsFailed)
  
  - publishToKafka(PaymentOutbox outbox): 
      * Kafka'ya mesaj gönderir
      * Senkron çalışır (10 saniye timeout)
  
  - reportDeadLetters(): 
      * Her 1 dakikada bir çalışır
      * 5 kez denenen ama başarısız olan event'leri raporlar
  
  - cleanupProcessedEvents(): 
      * Her gece yarısı çalışır
      * 7 günden eski işlenmiş event'leri siler
  
  - getStats(): 
      * Outbox istatistiklerini döner (pending, processed, deadLetters)

--------------------------------------------------------------------------------
6. Payment (Entity)
--------------------------------------------------------------------------------
AÇIKLAMA: Ödeme veritabanı entity'si

ALANLAR:
  - id: Ödeme ID'si (UUID)
  - orderId: Sipariş ID'si
  - userId: Kullanıcı ID'si
  - amount: Tutar
  - currency: Para birimi
  - status: Ödeme durumu (PENDING, SUCCESS, FAILED, REFUNDED, REFUND_FAILED)
  - paymentMethod: Ödeme yöntemi (CREDIT_CARD, DEBIT_CARD, DIGITAL_WALLET)
  - externalTransactionId: Dış sistem işlem ID'si
  - failureReason: Başarısızlık nedeni
  - maskedCardNumber: Maskelenmiş kart numarası
  - cardHolderName: Kart sahibi adı
  - createdAt: Oluşturulma tarihi
  - updatedAt: Güncellenme tarihi

INDEX'LER:
  - idx_payment_order_id: orderId üzerinde index
  - idx_payment_user_id: userId üzerinde index

--------------------------------------------------------------------------------
7. PaymentOutbox (Entity)
--------------------------------------------------------------------------------
AÇIKLAMA: Transactional Outbox Pattern için event saklama entity'si

ALANLAR:
  - id: Outbox ID'si
  - aggregateType: Aggregate tipi ("Payment" veya "Order")
  - aggregateId: Aggregate ID'si
  - eventType: Event tipi (PAYMENT_SUCCESS, PAYMENT_FAILED, ORDER_COMPLETED)
  - topic: Kafka topic'i ("payment-events" veya "order-events")
  - payload: Event verisi (JSON string)
  - processed: İşlendi mi?
  - processedAt: İşlenme tarihi
  - retryCount: Tekrar deneme sayısı
  - lastError: Son hata mesajı
  - createdAt: Oluşturulma tarihi

METODLAR:
  - canRetry(): Tekrar denenebilir mi? (retryCount < 5)
  - markAsProcessed(): İşlendi olarak işaretler
  - markAsFailed(String errorMessage): Başarısız olarak işaretler
  - isDeadLetter(): Dead letter mı? (retryCount >= 5)

INDEX'LER:
  - idx_outbox_processed: processed üzerinde index
  - idx_outbox_created_at: createdAt üzerinde index

--------------------------------------------------------------------------------
8. PaymentRepository
--------------------------------------------------------------------------------
AÇIKLAMA: Payment entity'si için JPA Repository

METODLAR:
  - JpaRepository'den gelen standart metodlar (save, findById, findAll, delete, vb.)

--------------------------------------------------------------------------------
9. PaymentOutboxRepository
--------------------------------------------------------------------------------
AÇIKLAMA: PaymentOutbox entity'si için JPA Repository

METODLAR:
  - findUnprocessedOutboxEvents(): 
      * İşlenmemiş ve retry sayısı 5'ten az olan event'leri bulur
  
  - findUnprocessedWithLimit(int limit): 
      * Limit ile işlenmemiş event'leri bulur (native query)
  
  - findDeadLetterEvents(): 
      * Dead letter event'leri bulur (retryCount >= 5)
  
  - deleteProcessedBefore(LocalDateTime threshold): 
      * Belirli tarihten önceki işlenmiş event'leri siler
  
  - findByAggregateIdOrderByCreatedAtAsc(String aggregateId): 
      * Aggregate ID'ye göre event'leri bulur
  
  - countByProcessedFalse(): İşlenmemiş event sayısı
  - countByProcessedTrue(): İşlenmiş event sayısı
  - countDeadLetters(): Dead letter sayısı

--------------------------------------------------------------------------------
10. PaymentStatus (Enum)
--------------------------------------------------------------------------------
AÇIKLAMA: Ödeme durumları

DEĞERLER:
  - PENDING: Beklemede
  - SUCCESS: Başarılı
  - FAILED: Başarısız
  - REFUNDED: İade edildi
  - REFUND_FAILED: İade başarısız

--------------------------------------------------------------------------------
11. PaymentMethod (Enum)
--------------------------------------------------------------------------------
AÇIKLAMA: Ödeme yöntemleri

DEĞERLER:
  - CREDIT_CARD: Kredi kartı
  - DEBIT_CARD: Banka kartı
  - DIGITAL_WALLET: Dijital cüzdan

--------------------------------------------------------------------------------
12. PaymentEvent (DTO - PaymentServiceImpl içinde)
--------------------------------------------------------------------------------
AÇIKLAMA: Kafka'ya gönderilen payment event DTO'su

ALANLAR:
  - eventType: Event tipi
  - paymentId: Ödeme ID'si
  - orderId: Sipariş ID'si
  - userId: Kullanıcı ID'si
  - amount: Tutar (string)
  - currency: Para birimi
  - status: Durum
  - createdAt: Oluşturulma tarihi (string)

--------------------------------------------------------------------------------
13. OrderCompletedEvent (DTO - PaymentServiceImpl içinde)
--------------------------------------------------------------------------------
AÇIKLAMA: Kafka'ya gönderilen order completed event DTO'su

ALANLAR:
  - eventType: "ORDER_COMPLETED"
  - orderId: Sipariş ID'si
  - userId: Kullanıcı ID'si
  - paymentId: Ödeme ID'si

================================================================================
